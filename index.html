<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система оценок</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Подключение Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script>
        // Ваша конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCfII279Y-Np3by_EOAu37dUfYe7-APdZg",
            authDomain: "setevoigorod-7d5a8.firebaseapp.com",
            projectId: "setevoigorod-7d5a8",
            storageBucket: "setevoigorod-7d5a8.appspot.com",
            messagingSenderId: "777501181808",
            appId: "1:777501181808:web:2ed26464d7f4ad6c25b1b5",
            measurementId: "G-WNFHGTHGFS"
        };

        // Инициализация Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Функция для обновления количества активных пользователей
        function updateActiveUsers(count) {
            document.getElementById('active-users').innerText = `Пользователей онлайн: ${count}`;
        }

        // Функция для увеличения и уменьшения счетчика активных пользователей
        function updateUserCount(isJoining) {
            const userRef = db.collection("activeUsers").doc("userCount");

            if (isJoining) {
                userRef.update({ count: firebase.firestore.FieldValue.increment(1) });
            } else {
                userRef.update({ count: firebase.firestore.FieldValue.increment(-1) });
            }
        }

        // Функция для получения количества активных пользователей
        function getActiveUsers() {
            const userRef = db.collection("activeUsers").doc("userCount");
            userRef.get().then((doc) => {
                if (doc.exists) {
                    updateActiveUsers(doc.data().count);
                } else {
                    userRef.set({ count: 0 });
                }
            }).catch((error) => {
                console.error("Ошибка при получении активных пользователей: ", error);
            });
        }

        // Функция для сохранения оценок
        function saveGrades() {
            const inputs = document.querySelectorAll('input[type="number"]');
            const grades = {};

            inputs.forEach(input => {
                const name = input.getAttribute('data-name');
                const date = input.getAttribute('data-date');
                const value = input.value;

                if (!grades[name]) {
                    grades[name] = {};
                }
                grades[name][date] = value;

                // Сохранение оценок в Firestore
                db.collection("grades").doc(name).set(grades[name])
                    .then(() => {
                        displayStatus("Оценки сохранены!", true);
                    })
                    .catch((error) => {
                        console.error("Ошибка при сохранении оценок: ", error);
                        displayStatus("Ошибка при сохранении оценок!", false);
                    });
            });
        }

        // Функция для загрузки оценок из Firestore
        function loadGrades() {
            const inputs = document.querySelectorAll('input[type="number"]');

            inputs.forEach(input => {
                const name = input.getAttribute('data-name');
                const date = input.getAttribute('data-date');

                db.collection("grades").doc(name).get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data[date]) {
                            input.value = data[date];
                        }
                    }
                }).catch((error) => {
                    console.error("Ошибка при загрузке оценок: ", error);
                });
            });
        }

        // Отображение статуса
        function displayStatus(message, success) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerText = message;
            statusDiv.style.color = success ? 'green' : 'red';
        }

        // Загрузка оценок и активных пользователей при загрузке страницы
        window.onload = function() {
            loadGrades();
            getActiveUsers();
            updateUserCount(true); // Увеличиваем счетчик при входе

            // Удаляем пользователя из активных при закрытии окна
            window.addEventListener("beforeunload", () => {
                updateUserCount(false);
            });
        };
    </script>
</head>
<body>

<h1>Выставление оценок</h1>

<!-- Количество пользователей онлайн -->
<div id="active-users" style="font-size: 18px; margin-bottom: 20px;"></div>

<!-- Логин для админа -->
<div id="login-form">
    <h2>Вход для администратора</h2>
    <label for="login">Логин:</label>
    <input type="text" id="login"><br>
    <label for="password">Пароль:</label>
    <input type="password" id="password"><br>
    <button onclick="adminLogin()">Войти</button>
    <div id="login-status"></div>
    <button id="guest-btn" onclick="guestLogin()">Войти как гость</button>
</div>

<!-- Таблица оценок -->
<div id="grades-section" style="display: none;">
    <table>
        <thead>
            <tr>
                <th>Имя Фамилия</th>
                <th>01.10.2024</th>
                <th>02.10.2024</th>
                <th>03.10.2024</th>
                <th>04.10.2024</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Есаян Майя</td>
                <td><input type="number" min="2" max="5" data-name="esayan_maya" data-date="01.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="esayan_maya" data-date="02.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="esayan_maya" data-date="03.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="esayan_maya" data-date="04.10.2024"></td>
            </tr>
            <tr>
                <td>Егор Баранов</td>
                <td><input type="number" min="2" max="5" data-name="egor_baranov" data-date="01.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="egor_baranov" data-date="02.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="egor_baranov" data-date="03.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="egor_baranov" data-date="04.10.2024"></td>
            </tr>
            <tr>
                <td>Маша Михаил</td>
                <td><input type="number" min="2" max="5" data-name="masha_mikhail" data-date="01.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="masha_mikhail" data-date="02.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="masha_mikhail" data-date="03.10.2024"></td>
                <td><input type="number" min="2" max="5" data-name="masha_mikhail" data-date="04.10.2024"></td>
            </tr>
        </tbody>
    </table>

    <button id="save-btn" onclick="saveGrades()" style="display: none;">Сохранить оценки</button>
    <div id="status"></div>
</div>

</body>
</html>
